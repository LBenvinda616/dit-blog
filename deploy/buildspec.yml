version: 0.2

phases:
  build:
    commands:
      - echo "Starting remote deploy via SSM"
      - if [ -z "$INSTANCE_ID" ]; then echo "INSTANCE_ID not set"; exit 1; fi
      - REPOSITORY_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
      - |
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$INSTANCE_ID" \
          --document-name "AWS-RunShellScript" \
          --comment "Deploy dit-blog containers" \
          --parameters commands="[\
            'cd /home/ubuntu/dit-blog/infra',\
            'chmod +x scripts/deploy.sh',\
            'AWS_ACCOUNT_ID=$AWS_ACCOUNT_ID AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION ./scripts/deploy.sh /home/ubuntu/dit-blog/infra'\
          ]" \
          --output text \
          --query 'Command.CommandId')
      - echo "SSM Command ID: $COMMAND_ID"
      - echo "Waiting for command to complete..."
      - |
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$INSTANCE_ID"
      - echo "Getting command output..."
      - |
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$INSTANCE_ID" \
          --query 'StandardOutputContent' \
          --output text
      - echo "Deploy completed"

artifacts:
  files: []

env:
  variables:
    AWS_ACCOUNT_ID: "828414850187"
    AWS_DEFAULT_REGION: "eu-north-1"
    # Set INSTANCE_ID in the CodeBuild project environment
